<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="color-scheme" content="dark light">
    <title>BLE-RC</title>
    <style>
    :root {
        --hue-bg: 225;
        --sat-bg: 14%;
        --lit-bg: 20%;
        --hue-fg: 0;
        --sat-fg: 0%;
        --lit-fg: 80%;
        --clr-bg: hsl(var(--hue-bg), var(--sat-bg), var(--lit-bg));
        --clr-fg: hsl(var(--hue-fg), var(--sat-fg), var(--lit-fg));
        --clr-mousepad-bg: hsl(var(--hue-bg), var(--sat-bg), calc(var(--lit-bg) + 5%));
        --clr-btn-bg: hsl(var(--hue-bg), var(--sat-bg), calc(var(--lit-bg) + 10%));
        --clr-btn-border: hsl(var(--hue-bg), var(--sat-bg), calc(var(--lit-bg) + 50%));
        --clr-alert: red;
        --gap: 1rem;
        --gap-small: calc(var(--gap) / 2);
        --gap-big: calc(var(--gap) + var(--gap) / 4);
        --gap-minimal: calc(var(--gap) / 4);
        --font-size: 16px;
        --line-height: 1.2;
        --menu-width: calc(min(75vw, 20rem) - 2 * var(--gap));
        --nav-height: calc((2rem * var(--line-height)) + 2 * var(--gap-small));
        --nav-shadow-width: 200px;
        --nav-shadow: 0 0 var(--nav-shadow-width) hsla(0 0% 0% / .5);
        --dpad-gap: 1em;
        --dpad-ok-width: 40%;
        --clr-dpad-gap: var(--clr-bg);
        --bs-remote-btn: 
            inset hsla(var(--hue-bg) var(--sat-bg) 15% / 1) 0 0px 0px 4px,
            inset hsla(var(--hue-bg) var(--sat-bg) 15% / .8) 0 -1px 5px 4px,
            inset hsla(var(--hue-bg) var(--sat-bg)  0% / .25) 0 -1px 0px 7px,
            inset hsla(var(--hue-bg) var(--sat-bg) 32% / .7) 0 2px 1px 7px,
            hsla(var(--hue-bg) var(--sat-bg) 0% / .15) 0 -5px 6px 4px,
            hsla(var(--hue-bg) var(--sat-bg) 30% / .3) 0 5px 6px 4px;
        --bs-mousepad: 
            /* inset hsla(var(--hue-bg) var(--sat-bg) 15% / 1) 0 0px 0px 4px,
            inset hsla(var(--hue-bg) var(--sat-bg) 15% / .8) 0 -1px 5px 4px,
            inset hsla(var(--hue-bg) var(--sat-bg)  0% / .25) 0 -1px 0px 7px,
            inset hsla(var(--hue-bg) var(--sat-bg) 32% / .7) 0 2px 1px 7px, */
            hsla(var(--hue-bg) var(--sat-bg) 0% / .15) 0 -5px 6px 4px,
            hsla(var(--hue-bg) var(--sat-bg) 30% / .3) 0 5px 6px 4px;
        /* --ts-remote-btn: 
            hsla(var(--hue-bg) var(--sat-bg) 40% / .5) 0 -1px 0,
            hsla(var(--hue-bg) var(--sat-bg) 100% /.6) 0 2px 1px; */
        --ts-remote-btn: none;
        --brush-metal-dark: 
            repeating-linear-gradient(0deg,
                hsla(0,0%,50%,0) 0%,
                hsla(0,0%,50%,0) 3%,
                hsla(0,0%,50%,.02) 4.5%),
            repeating-linear-gradient(0deg, 
                hsla(0,0%,0%,0) 0%,
                hsla(0,0%,0%,0) 2%,
                hsla(0,0%,0%,.01) 2.5%),
            repeating-linear-gradient(0deg,
                hsla(0,0%,50%,0) 0%,
                hsla(0,0%,50%,0) 0.6%,
                hsla(0,0%,50%,.03) 1.2%),
            repeating-linear-gradient(0deg, 
                hsla(0,0%,0%,0) 0%,
                hsla(0,0%,0%,0) 2%,
                hsla(0,0%,0%,.02) 2.5%),
            repeating-linear-gradient(0deg, 
                hsla(0,0%,0%,0) 0%,
                hsla(0,0%,0%,0) 2%,
                hsla(0,0%,0%,.01) 2.5%);
        --gradient-btn:
            linear-gradient(
                to bottom,
                hsl(var(--hue-bg) var(--sat-bg) 35%) 0%,
                hsl(var(--hue-bg) var(--sat-bg) 15%) 46%,
                hsl(var(--hue-bg) var(--sat-bg) 10%) 50%,
                hsl(var(--hue-bg) var(--sat-bg) 14%) 53%,
                hsl(var(--hue-bg) var(--sat-bg) 5%) 76%,
                hsl(var(--hue-bg) var(--sat-bg) 14%) 87%,
                hsl(var(--hue-bg) var(--sat-bg) 7%) 100%);
        --bg-remote-btn: 
            var(--brush-metal-dark),
            var(--gradient-btn);
        --bg-remote-dpad-btn:
            var(--brush-metal-dark),
            var(--gradient-btn);
        --bg-black-metal: 
            var(--brush-metal-dark),
            linear-gradient(80deg,
                var(--clr-bg) 0%,
                hsl(var(--hue-bg) var(--sat-bg) 4%) 40%,
                hsl(var(--hue-bg) var(--sat-bg) 12%) 55%,
                hsl(var(--hue-bg) var(--sat-bg) 12%) 65%,
                hsl(var(--hue-bg) var(--sat-bg) 4%) 75%,
                var(--clr-bg) 100%);
        --bg-dark-metal: 
            var(--brush-metal-dark),
            linear-gradient(80deg,
                var(--clr-bg) 0%,
                hsl(var(--hue-bg) var(--sat-bg) 8%) 40%,
                hsl(var(--hue-bg) var(--sat-bg) 9%) 55%,
                hsl(var(--hue-bg) var(--sat-bg) 9%) 65%,
                hsl(var(--hue-bg) var(--sat-bg) 8%) 75%,
                var(--clr-bg) 100%);
        font-size: var(--font-size);
        line-height: var(--line-height);
        --accent-color: dodgerblue;
        accent-color: var(--accent-color);
    }
    * {
        box-sizing: border-box;
        padding: 0;
        margin: 0;
        font-family: sans-serif;
        user-select: none;
    }
    ::selection {
        background-color: var(--accent-color);
        color: white;
    }
    body {
        background-image: var(--bg-black-metal);
        color: var(--clr-fg);
        overflow-x: hidden;
        width: 100vw;
        min-height: 100vh;
    }
    .nav-shadow {
        position: absolute;
        inset: 0 0 auto 0;
        height: var(--nav-height);
        box-shadow: var(--nav-shadow);
    }
    nav {
        background: var(--bg-dark-metal);
        padding: var(--gap-small);
        color: var(--clr-fg);
    }
    nav:not(.menu) {
        display: flex;
        gap: var(--gap-small);
        font-size: 2em;
        margin-bottom: var(--gap);
        position: sticky;
        inset: 0 0 auto;
        z-index: 1;
        overflow: hidden;
    }
    nav a {
        display: inline-block;
        color: inherit;
        text-decoration: none;
    }
    nav a svg {
        width: 1.5em !important;
        height: 1.5em !important;
    }
    nav:not(.menu) a {
        opacity: .5;
    }
    nav:not(.menu) a:last-of-type {
        margin-left: auto;
    }
    .sending nav:not(.menu):before,
    .sending nav:not(.menu):after {
        content: "";
        position: absolute;
        inset: 0;
        margin: auto;
        border-radius: 50%;
        border: 10px solid hsla(0 0% 50% / .5);
        animation-name: nav-ripple;
        animation-duration: 2s;
        animation-iteration-count: infinite;
        animation-timing-function: cubic-bezier(0,.72,.62,.95);
        transform: scale(0);
    }
    .sending nav:not(.menu):after {
        animation-delay: 0.5s;
    }
    @keyframes nav-ripple {
        from {
            opacity: 1;
            transform: scale(0);
        }
        to {
            opacity: 0;
            transform: scale(1.5);
        }
    }
    nav.menu {
        position: fixed;
        font-size: 1.25em;
        width: var(--menu-width);
        inset: var(--nav-height) 0 0 auto;
        transition: transform 250ms ease-out; 
        transform: translateX(calc(var(--menu-width) + var(--nav-shadow-width) + 2 * var(--gap-small)));
        box-shadow: var(--nav-shadow);
        display: flex;
        flex-direction: column;
    }
    nav.menu[data-open="true"] {
        transform: translateX(0);
    }
    nav.menu a {
        display: block;
        text-align: right;
        padding: var(--gap) var(--gap) 0;
    }
    nav.menu a[data-bottom="true"] {
        margin-top: auto;
    }
    button {
        background: var(--bg-remote-btn);
        box-shadow: var(--bs-remote-btn);
        text-shadow: var(--ts-remote-btn);
        border: 1px solid var(--clr-btn-border);
        color: var(--clr-fg);
    }
    button:active {
        --lit-bg: 10%;
    }
    .ws-off button {
        opacity: .5;
        pointer-event: none;
    }
    .buttons {
        display: inline-grid;
        gap: var(--gap-small);
        place-items: center;
    }
    button[data-key] {
        aspect-ratio: 1;
        font-size: 2em;
        height: 1.4em;
        border: none;
        border-radius: .2em;
        position: relative;
    }
    .col-3 {
        grid-template-columns: repeat(3, 1fr);
    }
    .col-4 {
        grid-template-columns: repeat(4, 1fr);
    }
    .col-5 {
        grid-template-columns: repeat(5, 1fr);
        padding-block: var(--gap);
    }
    .p-block {
        padding-block: var(--gap);
    }
    .p-inline {
        padding-inline: var(--gap);
    }
    main {
        display: grid;
        gap: var(--gap);
    }
    section.remote {
        display: grid;
        grid-template-columns: 1fr;
        place-items: center;
        gap: var(--gap);
        position: relative;
        z-index: 0;
    }
    section.remote:before {
        position: absolute;
        inset-block: calc(-1 * var(--gap));
        width: 19em;
        background: var(--bg-remote-btn);
        z-index: 0;
        border-radius: 1em;
    }
    section.remote > * {
        z-index: 1;
    }
    section.keyboard {
        display: grid;
        gap: var(--gap-minimal);
        width: 100%;
    }
    main:not([data-page="learn"]) section.keyboard {
        position: fixed;
        bottom: var(--gap-minimal);
    }
    section.mouse {
        width: min(40rem, calc(100vw - 2 * var(--gap)));
        position: fixed;
        inset: auto var(--gap) var(--gap);
        margin-inline: auto;
        display: grid;
        grid-template-areas: 
            "mouse mouse mouse"
            "left middle right";
        grid-template-columns: 1.25fr .5fr 1.25fr;
        grid-template-rows: 3fr 1fr;
    }
    section.mouse .pad {
        width: 100%;
        aspect-ratio: 4 / 3;
        background: var(--clr-mousepad-bg);
        margin-inline: auto;
        border-top-left-radius: .75rem;
        border-top-right-radius: .75rem;
        border: 2px inset var(--clr-btn-bg);
        box-shadow: var(--bs-mousepad);
        grid-area: mouse;
        touch-action: none; /* improves mouse action @see https://stackoverflow.com/questions/16348031/disable-scrolling-when-touch-moving-certain-element */ 
    }
    section.mouse .mouse-btn {
        background: var(--clr-mousepad-bg);
        border: 2px outset var(--clr-btn-bg);
        box-shadow: var(--bs-mousepad);
    }
    section.mouse .left {
        grid-area: left;
        border-bottom-left-radius: .75rem;
    }
    section.mouse .middle {
        grid-area: middle;
    }
    section.mouse .right {
        grid-area: right;
        border-bottom-right-radius: .75rem;
    }
    /* Router */
    main:not([data-page="remote"]):not([data-page="learn"]) section.remote > div,
    main:not([data-page="keyboard"]):not([data-page="learn"]) section.keyboard,
    main:not([data-page="mouse"]) section.mouse,
    main:not([data-page="learn"]) section.config,
    main:not([data-page="ota"]) section.ota {
        display: none;
    }
    main[data-page="keyboard"] section.remote > div:is(.dpad),
    main[data-page="keyboard"] section.remote > div:is(.functional) {
        display: grid;
    }
    /* /Router */

    /* DPAD */
    .dpad {
        display: grid;
        place-items: center;
        grid-template-areas: "volume dpad channels";
        grid-template-columns: 20% 60% 20%;
        width: 18rem;
        aspect-ratio: 14 / 10;
    }
    .dpad > div {
        grid-area: dpad;
    }
    .dpad .background, .dpad .directions, .dpad .buttons {
        width: 100%;
        aspect-ratio: 1;
    }
    .dpad .background {
        display: grid;
        grid-template-areas: "dpad-background";
        place-items: center;
        border-radius: 50%;
        overflow: hidden;
        box-shadow: var(--bs-remote-btn);
        text-shadow: var(--ts-remote-btn);
    }
    .dpad .background .directions {
        grid-area: dpad-background;
        display: grid;
        gap: var(--dpad-gap);
        grid-template-columns: repeat(2, 1fr);
        grid-template-rows: repeat(2, 1fr);
        transform: rotate(45deg);
        background-image: var(--bg-black-metal);
    }
    .dpad .dir, .dpad .ok {
        aspect-ratio: 1;
        background: var(--bg-remote-dpad-btn);
        box-shadow: var(--bs-remote-btn);
        text-shadow: var(--ts-remote-btn);
    }
    .dpad .ok-outline {
        grid-area: dpad-background;
        width: calc(var(--dpad-ok-width) + var(--dpad-gap));
        border-radius: 50%;
        transform: rotate(0deg);
        aspect-ratio: 1;
        background: var(--bg-black-metal);
    }
    .dpad .ok {
        grid-area: dpad-background;
        width: var(--dpad-ok-width);
        border-radius: 50%;
        transform: rotate(0deg);
    }
    /** Buttons */
    .dpad .buttons {
        display: grid;
        grid-template-columns: 1fr calc(var(--dpad-ok-width) + 2 * var(--dpad-gap)) 1fr;
        grid-template-rows: 1fr calc(var(--dpad-ok-width) + 2 * var(--dpad-gap)) 1fr;
        gap: revert;
        transform: rotate(0deg);
    }
    .dpad button {
        border: none;
        color: var(--clr-fg);
        font-size: 1.6em;
        min-width: 1.3em;
        height: revert;
        aspect-ratio: revert;
    }
    .dpad .buttons button {
        background: none;
        box-shadow: none;
    }
    .dpad .volume {
        grid-area: volume;
    }
    .dpad .channels {
        grid-area: channels;
    }
    .dpad .volume, .dpad .channels {
        display: grid;
        grid-template-columns: 1fr;
        place-content: space-around;
        height: 100%;
        justify-self: stretch;
        padding: var(--gap-small);
    }
    .dpad .volume button, .dpad .channels button {
        width: 100%;
        aspect-ratio: 1;
        border-radius: 50%;
        background-color: var(--clr-btn-bg);
    }
    .dpad .volume span, .dpad .channels span {
        text-align: center;
    }
    /* /DPAD */
    .keyboard > div {
        display: flex;
        justify-content: center;
        gap: var(--gap-minimal);
        margin-bottom: var(--gap-minimal);
    }
    .keyboard button[data-key] {
        aspect-ratio: revert;
        padding-inline: .4em;
        flex-grow: .1;
        height: 1.6em;
    }
    .keyboard > div:last-child {
        justify-content: space-between;
    }
    .keyboard > div:last-child button:nth-child(2) {
        flex-grow: 1;
    }
    /* icons */
    button span.svg-icon {
        display: grid;
        place-items: center;
        position: absolute;
        inset: 0;
        color: var(--clr-fg);
        font-size: .5em;
    }
    button span.svg-icon.power {
        color: var(--clr-alert);
    }
    button span.svg-icon.red {
        color: var(--clr-alert);
    }
    button span.svg-icon.green {
        color: greenyellow;
    }
    button span.svg-icon.yellow {
        color: yellow;
    }
    button span.svg-icon.blue {
        color: blue;
    }
    .dpad .buttons button > span {
        position: static;
    }
    /* /icons */
    .config {
        display: grid;
        gap: var(--gap-small);
    }
    .config p {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .config button {
        border: none;
        padding: .75rem 1.5rem;
        color: var(--clr-alert);
        font-size: 1.2em;
    }
    .overlay {
        position: fixed;
        inset: 0;
        background: hsla(0 0% 0% / .8);
        place-items: center;
        display: none;
        z-index: 1;
        padding: var(--gap);
    }
    .overlay.active {
        display: grid;
    }
    .overlay > button {
        color: var(--clr-alert);
        position: absolute;
        inset: var(--gap-big) var(--gap-big) auto auto;
        border: none;
        font-size: 2em;
    }
    .overlay p {
        text-align: center;
    }
    .overlay p > span {
        font-size: 2em;
    }

    /* Form */
    form {
        margin: var(--gap-small);
    }
    form > * {
        margin-bottom: var(--gap);
    }
    fieldset {
        padding: var(--gap-small);
        border-color: var(--clr-border);
    }
    h1,
    legend,
    label {
        user-select: none;
    }
    form button[type="submit"] {
        background: var(--accent-color);
        color: var(--clr-fg);
        font-size: 1.5em;
        padding: .75rem 1.5rem;
        border: none;
        border-radius: .25rem;
        box-shadow: none;
    }
    form button[type="submit"]:disabled {
        opacity: .5;
    }
    input:not([type="checkbox"]) {
        font-size: 1.5em;
        width: 100%;
        padding: var(--gap-minimal);
        border: 1px solid var(--clr-border);
    }
    input[type="file"] {
        font-size: 1em;
    }
    input {
        accent-color: var(--accent-color);
        background-color: inherit;
        color: inherit;
    }
    label {
        padding-top: var(--gap-small);
        display: block;
    }
    form > p.cta {
        text-align: right;
    }
    form p.result, form p.reload {
        text-align: center;
    }
    form p.result[data-error="true"] {
        color: var(--clr-alert);
    }
    form progress {
        display: block;
        margin-inline: auto;
    }
    form progress[data-show="false"],
    form p.reload[data-show="false"] {
        display: none;
    }
    /* /Form */

    @media (max-width: 30rem) {
        :root {
            --gap: .85rem;
        }
        .keyboard button[data-key] {
            padding-inline: .3em;
            font-size: 1.5em;
        }
    }
    </style>
    <link rel="icon" href="data:,">
</head>
<body class="ws-off">
    <div class="nav-shadow"></div>
    <nav>
        <a href="/remote"><svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M8.16,3L6.75,4.41L9.34,7H4C2.89,7 2,7.89 2,9V19C2,20.11 2.89,21 4,21H20C21.11,21 22,20.11 22,19V9C22,7.89 21.11,7 20,7H14.66L17.25,4.41L15.84,3L12,6.84L8.16,3M4,9H17V19H4V9M19.5,9A1,1 0 0,1 20.5,10A1,1 0 0,1 19.5,11A1,1 0 0,1 18.5,10A1,1 0 0,1 19.5,9M19.5,12A1,1 0 0,1 20.5,13A1,1 0 0,1 19.5,14A1,1 0 0,1 18.5,13A1,1 0 0,1 19.5,12Z" /></svg></a>
        <a href="/keyboard"><svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M7,22H9V24H7V22M11,22H13V24H11V22M15,22H17V24H15V22M4,5A2,2 0 0,0 2,7V17A2,2 0 0,0 4,19H20A2,2 0 0,0 22,17V7A2,2 0 0,0 20,5H4M4,7H20V17H4V7M5,8V10H7V8H5M8,8V10H10V8H8M11,8V10H13V8H11M14,8V10H16V8H14M17,8V10H19V8H17M5,11V13H7V11H5M8,11V13H10V11H8M11,11V13H13V11H11M14,11V13H16V11H14M17,11V13H19V11H17M8,14V16H16V14H8Z" /></svg></a>
        <a href="/mouse"><svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M11,1.07C7.05,1.56 4,4.92 4,9H11M4,15A8,8 0 0,0 12,23A8,8 0 0,0 20,15V11H4M13,1.07V9H20C20,4.92 16.94,1.56 13,1.07Z" /></svg></a>
        <a href="/menu"><svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg></a>
    </nav>
    <main data-page="remote">
        <section class="config p-inline">
            <h1>Configure</h1>
            <p>Delete the entire configuration <button name="clear">&times;</button></p>
            <p>Forget a single button <button name="forget">&times;</button></p>
            <p>Hit the button you want learn and press the button on your IR remote.</p>
        </section>
        <section class="remote">
            <div class="dpad">
                <div class="volume">
                    <button>&plus;</button>
                    <span>Vol</span>
                    <button>&minus;</button>
                </div>
                <div class="background">
                    <div class="directions">
                        <div class="dir" data-dir="up"></div>
                        <div class="dir" data-dir="right"></div>
                        <div class="dir" data-dir="down"></div>
                        <div class="dir" data-dir="left"></div>
                    </div>
                    <div class="ok-outline"></div>
                    <div class="ok"></div>
                </div>
                <div class="buttons">
                    <span></span>
                    <button>&utrif;</button>
                    <span></span>
                    
                    <button>&ltrif;</button>
                    <button>OK</button>
                    <button>&rtrif;</button>
                    
                    <span></span>
                    <button>&dtrif;</button>
                    <span></span>
                </div>
                <div class="channels">
                    <button>&plus;</button>
                    <span>Ch</span>
                    <button>&minus;</button>
                </div>
            </div>
        </section>
        <section class="keyboard"></section>
        <section class="mouse">
            <div class="pad"></div>
            <div class="mouse-btn left" data-button="1"></div>
            <div class="mouse-btn middle" data-button="4"></div>
            <div class="mouse-btn right" data-button="2"></div>
        </section>
        <section class="ota">
            <form action="/update" method="post" enctype='multipart/form-data'>
                <h1>Over The Air update</h1>
                <fieldset>
                    <legend>Choose File:</legend>
                    <input type="file">
                    <progress value="0" max="100" data-show="false"></progress>
                    <p class="result"></p>
                    <p class="reload" data-show="false">Reload in <span></span> seconds...</p>
                </fieldset>
                <p class="cta">
                    <button type="submit" disabled="disabled">Upload</button>
                </p>
            </form>
        </section>
    </main>
    <nav class="menu">
        <a href="/learn">Learn IR Codes</a>
        <a href="/ota" data-bottom="true">OTA Update</a>
        <a href="/reboot">Reboot</a>
    </nav>
    <div class="overlay learn">
        <button class="cancelIr">&times;</button>
        <p class="buttons"><span>Now press the button on your remote to learn</span> <button data-key>&times;</button></p>
    </div>
    <div class="overlay forget">
        <button class="cancelIr">&times;</button>
        <p><span>Now press the button on your remote to be forgotten.</span></p>
    </div>
    <script>

        const icons = {
            empty: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="" /></svg>',
            power: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M16.56,5.44L15.11,6.89C16.84,7.94 18,9.83 18,12A6,6 0 0,1 12,18A6,6 0 0,1 6,12C6,9.83 7.16,7.94 8.88,6.88L7.44,5.44C5.36,6.88 4,9.28 4,12A8,8 0 0,0 12,20A8,8 0 0,0 20,12C20,9.28 18.64,6.88 16.56,5.44M13,3H11V13H13" /></svg>',
            mute: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M12,4L9.91,6.09L12,8.18M4.27,3L3,4.27L7.73,9H3V15H7L12,20V13.27L16.25,17.53C15.58,18.04 14.83,18.46 14,18.7V20.77C15.38,20.45 16.63,19.82 17.68,18.96L19.73,21L21,19.73L12,10.73M19,12C19,12.94 18.8,13.82 18.46,14.64L19.97,16.15C20.62,14.91 21,13.5 21,12C21,7.72 18,4.14 14,3.23V5.29C16.89,6.15 19,8.83 19,12M16.5,12C16.5,10.23 15.5,8.71 14,7.97V10.18L16.45,12.63C16.5,12.43 16.5,12.21 16.5,12Z" /></svg>',
            ["skip-backward"]: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M20,5V19L13,12M6,5V19H4V5M13,5V19L6,12" /></svg>',
            rew: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M11.5,12L20,18V6M11,18V6L2.5,12L11,18Z" /></svg>',
            ffw:'<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M13,6V18L21.5,12M4,18L12.5,12L4,6V18Z" /></svg>',
            ["skip-forward"]:'<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M4,5V19L11,12M18,5V19H20V5M11,5V19L18,12" /></svg>',
            rec: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M19,12C19,15.86 15.86,19 12,19C8.14,19 5,15.86 5,12C5,8.14 8.14,5 12,5C15.86,5 19,8.14 19,12Z" /></svg>',
            stop: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M18,18H6V6H18V18Z" /></svg>',
            ["play-pause"]:'<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M3,5V19L11,12M13,19H16V5H13M18,5V19H21V5" /></svg>',
            back: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M20 13.5V20H18V13.5C18 11 16 9 13.5 9H7.83L10.91 12.09L9.5 13.5L4 8L9.5 2.5L10.92 3.91L7.83 7H13.5C17.09 7 20 9.91 20 13.5Z" /></svg>',
            menu: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M3,6H21V8H3V6M3,11H21V13H3V11M3,16H21V18H3V16Z" /></svg>',
            previous: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M20 13.5C20 17.09 17.09 20 13.5 20H6V18H13.5C16 18 18 16 18 13.5S16 9 13.5 9H7.83L10.91 12.09L9.5 13.5L4 8L9.5 2.5L10.92 3.91L7.83 7H13.5C17.09 7 20 9.91 20 13.5Z" /></svg>',
            up: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41,15.41L12,10.83L16.59,15.41L18,14L12,8L6,14L7.41,15.41Z" /></svg>',
            down: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z" /></svg>',
            left: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M15.41,16.58L10.83,12L15.41,7.41L14,6L8,12L14,18L15.41,16.58Z" /></svg>',
            right: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M8.59,16.58L13.17,12L8.59,7.41L10,6L16,12L10,18L8.59,16.58Z" /></svg>',
            plus: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H13V19H11V13H5V11H11V5H13V11H19V13Z" /></svg>',
            minus: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M19,13H5V11H19V13Z" /></svg>',
            red: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg>',
            green: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg>',
            yellow: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg>',
            blue: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M12,20A8,8 0 0,1 4,12A8,8 0 0,1 12,4A8,8 0 0,1 20,12A8,8 0 0,1 12,20M12,2A10,10 0 0,0 2,12A10,10 0 0,0 12,22A10,10 0 0,0 22,12A10,10 0 0,0 12,2Z" /></svg>',
            keyboard: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M4,5A2,2 0 0,0 2,7V17A2,2 0 0,0 4,19H20A2,2 0 0,0 22,17V7A2,2 0 0,0 20,5H4M4,7H20V17H4V7M5,8V10H7V8H5M8,8V10H10V8H8M11,8V10H13V8H11M14,8V10H16V8H14M17,8V10H19V8H17M5,11V13H7V11H5M8,11V13H10V11H8M11,11V13H13V11H11M14,11V13H16V11H14M17,11V13H19V11H17M8,14V16H16V14H8Z" /></svg>',
            remote: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M8.16,3L6.75,4.41L9.34,7H4C2.89,7 2,7.89 2,9V19C2,20.11 2.89,21 4,21H20C21.11,21 22,20.11 22,19V9C22,7.89 21.11,7 20,7H14.66L17.25,4.41L15.84,3L12,6.84L8.16,3M4,9H17V19H4V9M19.5,9A1,1 0 0,1 20.5,10A1,1 0 0,1 19.5,11A1,1 0 0,1 18.5,10A1,1 0 0,1 19.5,9M19.5,12A1,1 0 0,1 20.5,13A1,1 0 0,1 19.5,14A1,1 0 0,1 18.5,13A1,1 0 0,1 19.5,12Z" /></svg>',
            home: '<svg xmlns="http://www.w3.org/2000/svg" style="width: 24px; height: 24px;" viewBox="0 0 24 24"><path fill="currentColor" d="M12 5.69L17 10.19V18H15V12H9V18H7V10.19L12 5.69M12 3L2 12H5V20H11V14H13V20H19V12H22L12 3Z" /></svg>',
        
        };

        class PageHandler {
            constructor(pageController) {
                this.pageController = pageController;
            }
        }
        class WebsocketHandler extends PageHandler {

            constructor(pageController) {
                super(pageController);
                this._active = false;
                this._attempts = 0;
                this._timeout = 2000;
                this._canReconnect = true;
                this._sendingStateTimeout = undefined;
                this._requestId = -1;
                this._callbacks = {};
            }

            get active() {
                return this._active && this.ws.readyState === WebSocket.OPEN;
            }

            set active(v) {
                this._active = typeof v == "boolean" && v;
            }

            get requestId() {
                return ++this._requestId;
            }

            run() {
                this.url = `ws://${location.host}:[%WS_PORT%]/jsonrpc`
                // this.url = `ws://192.168.178.218:81/jsonrpc`;
                this.initHandler()
                    .initWebsocket();
                return this;
            }

            initHandler() {
                this.openedHandler = this.handleOpen.bind(this);
                this.closedHandler = this.handleClose.bind(this);
                this.messageHandler = this.handleMessage.bind(this);
                this.timeoutHandler = this.handleTimeout.bind(this);
                return this;
            }

            initWebsocket() {
                this._attempts++;
                console.debug("[Websocket] connect attempt %d...", this._attempts);
                this.ws = new WebSocket(this.url);
                this.addListeners()
                return this;
            }

            addListeners() {
                this.ws.addEventListener("open", this.openedHandler);
                this.ws.addEventListener("error", this.closedHandler);
                this.ws.addEventListener("close", this.closedHandler);
                this.ws.addEventListener("message", this.messageHandler);
                return this;
            }

            removeListeners() {
                this.ws.removeEventListener("open", this.openedHandler);
                this.ws.removeEventListener("error", this.closedHandler);
                this.ws.removeEventListener("close", this.closedHandler);
                this.ws.removeEventListener("message", this.messageHandler);
                return this;
            }

            connect() {
                if (!this.ws || this.ws.readyState === WebSocket.CLOSED) {
                    this.initWebsocket();
                }
            }

            close() {
                this._canReconnect = false;
                this.ws.close();
            }

            handleOpen() {
                console.debug("[Websocket] open");
                this.active = true;
                this.pageController.active = true;
            }

            handleClose() {
                console.debug("[Websocket] closed");
                this.active = false;
                this.pageController.active = false;
                this.pageController.sending = false;
                this.removeListeners();
                delete this.ws;
                if (this._canReconnect) {
                    this.connect();
                }
            }

            handleMessage(result) {
                const data = JSON.parse(result.data);
                if (data.jsonrpc === "2.0") {
                    console.debug("[Websocket] incoming message", data);
                    if (this.wsTimeout) {
                        clearTimeout(this.wsTimeout);
                        delete this.wsTimeout;
                    }
                    if (data.result === "OK" || data.result?.result === "OK") {
                        if (data.result.method && "function" === typeof this._callbacks[data.id]) {
                            this._callbacks[data.id](data.result);
                            delete this._callbacks[data.id];
                        }
                        this.active = true;
                        console.debug("[Websocket] OK");
                    }
                }
            };

            handleTimeout() {
                console.debug("[Websocket] closing after timeout of %dms", this._timeout);
                this.ws.close();
                delete this.wsTimeout;
                this.pageController.active = false;
                this.pageController.sending = false;
            }

            keydown(btn) {
                console.debug("[Websocket] keydown", btn);
                this.active = false;
                this.send({
                    method: "keydown",
                    params: btn.dataset
                });
                this.pageController.sending = true;
            }

            keyup(btn) {
                console.debug("[Websocket] keyup", btn);
                this.send({
                    method: "keyup",
                    params: btn.dataset
                });
                if (this._sendingStateTimeout) {
                    clearTimeout(this._sendingStateTimeout);
                    this._sendingStateTimeout = undefined;
                }
                this.pageController.sending = false;
            }

            mouseDown(btn) {
                console.debug("[Websocket] mouseDown", btn);
                this.send({
                    method: "mousedown", skipResponse: true,
                    params: {
                        button: parseInt(btn.dataset.button, 10)
                    }
                });
            }

            mouseUp(btn) {
                console.debug("[Websocket] mouseUp", btn);
                this.send({
                    method: "mouseup", skipResponse: true,
                    params: {
                        button: parseInt(btn.dataset.button, 10)
                    }
                });
            }

            mouseMove(x, y) {
                console.debug("[Websocket] mousemove", x, y);
                this.send({
                    method: "mousemove", skipResponse: true,
                    params: {x, y}
                });
            }

            learn(btn, cb) {
                console.debug("[Websocket] learn", btn);
                this.send({
                    method: "learn",
                    params: btn.dataset
                }, cb);
            }

            forget(cb) {
                console.debug("[Websocket] forget");
                this.send({ method: "forget" }, cb);
            }

            cancelIr(cb) {
                console.debug("[Websocket] cancelIr");
                this.send({ method: "cancelIr" }, cb);
            }

            clear() {
                console.debug("[Websocket] clear");
                this.send({ method: "clear" });
            }

            reboot() {
                console.debug("[Websocket] reboot");
                this.send({ method: "reboot" });
            }

            send(message, cb) {
                if (this.pageController.active) {
                    const id = this.requestId;
                    if ("function" === typeof cb) {
                        this._callbacks[id] = cb;
                    }
                    message.jsonrpc = "2.0";
                    message.id = id;
                    console.debug("[Websocket] send", message);
                    this.ws.send(JSON.stringify(message));
                    if ("undefined" === typeof message.skipResponse && "undefined" === typeof this.wsTimeout) {
                        this.wsTimeout = setTimeout(this.timeoutHandler, this._timeout);
                    }
                }
            }
        }

        class Mouse extends PageHandler {
            constructor(pageController, node) {
                super(pageController);
                this.node = node;
                this.mouseIsDown = false;
                this.throttletimeout = 20;
                this.throttle = false;
                this.current = {
                    x:0,y:0
                }
                this.initElements().initListeners().addListeners();
            }
            initElements() {
                this.pad = this.node.querySelector('.pad');
                this.left = this.node.querySelector('.left');
                this.middle = this.node.querySelector('.middle');
                this.right = this.node.querySelector('.right');
                return this;
            }
            initListeners() {
                this.padDownHandler = this.handlePadDown.bind(this);
                this.padUpHandler = this.handlePadUp.bind(this);
                this.padMoveHandler = this.handlePadMove.bind(this);
                this.padEnterHandler = this.handlePadEnter.bind(this);
                this.padLeaveHandler = this.handlePadLeave.bind(this);
                this.buttonDownHandler = e => this.pageController.ws.mouseDown(e.currentTarget);
                this.buttonUpHandler = e => this.pageController.ws.mouseUp(e.currentTarget);
                return this;
            }
            addListeners() {
                this.pad.addEventListener('pointerdown', this.padDownHandler);
                this.pad.addEventListener('pointerup', this.padUpHandler);
                this.pad.addEventListener('pointermove', this.padMoveHandler);
                this.pad.addEventListener('pointerenter', this.padEnterHandler);
                this.pad.addEventListener('pointerleave', this.padLeaveHandler);
                this.left.addEventListener('pointerdown', this.buttonDownHandler);
                this.middle.addEventListener('pointerdown', this.buttonDownHandler);
                this.right.addEventListener('pointerdown', this.buttonDownHandler);
                this.left.addEventListener('pointerup', this.buttonUpHandler);
                this.middle.addEventListener('pointerup', this.buttonUpHandler);
                this.right.addEventListener('pointerup', this.buttonUpHandler);
                return this;
            }
            handlePadEnter(e) {
                if ("touch" === e.pointerType) {
                    this.current = {
                        x: e.layerX,
                        y: e.layerY
                    };
                }
            }
            handlePadLeave(e) {
                if ("mouse" === e.pointerType) {
                    this.mouseIsDown = false;
                }
            }
            handlePadDown(e) {
                if ("mouse" === e.pointerType) {
                    this.mouseIsDown = true;
                    this.current = {
                        x: e.layerX,
                        y: e.layerY
                    };
                }
            }
            handlePadUp(e) {
                if ("mouse" === e.pointerType) {
                    this.mouseIsDown = false;
                }
            }
            handlePadMove(e) {
                if ("mouse" === e.pointerType && !this.mouseIsDown) {
                    return;
                }
                const movementX = e.layerX - this.current.x;
                const movementY = e.layerY - this.current.y;
                if (!this.throttle) {
                    this.current = {
                        x: e.layerX,
                        y: e.layerY
                    }
                    this.pageController.ws.mouseMove(movementX, movementY);
                    this.throttle = true;
                    setTimeout(() => this.throttle = false, this.throttletimeout);
                }
            }
        }

        class ButtonsAbstract extends PageHandler {            

            constructor(pageController, parent) {
                super(pageController);
                this._container = null;
                this.parent = parent;
                this.keyDownHandler = this.pageController.handleKeydown.bind(this.pageController);
                this.keyUpHandler = this.pageController.handleKeyup.bind(this.pageController);
                for (let i of this) {
                    this.render(this.buttons[i], i);
                }
            }
            render(config, part) {
                const container = this.container;
                container.classList.add("buttons", part);
                if (config.classes) {
                    config.classes.forEach((c) => container.classList.add(c));
                }
                config.buttons.forEach((b) => {
                    let btn;
                    if (b.type > 0) {
                        btn = container.appendChild(document.createElement("button"));
                        btn.dataset.key = b.key;
                        btn.dataset.type = b.type;
                        btn.addEventListener("pointerdown", this.keyDownHandler);
                        btn.addEventListener("pointerup", this.keyUpHandler);
                    } else {
                        btn = container.appendChild(document.createElement("span"));
                    }
                    let label = b.label[0] === "." ? this.getSvgIcon(b.label) : b.label;
                    btn.innerHTML = label;
                });
            }

            getSvgIcon(def) {
                const className = def.replace(/^\./, ""); 
                const icon = icons[className];
                return `<span class="svg-icon ${className}">${icon}</span>`;
            }

            get container() {
                return this.parent.appendChild(document.createElement("div"));
            }

            get buttons() {
                return {};
            }

            [Symbol.iterator]() {
                let index = -1;
                let data = Object.keys(this.buttons);
                return {
                    next: () => ({ value: data[++index], done: !(index in data) })
                };
            }
        }

        class Upper extends ButtonsAbstract {
            get container() {
                return this.parent
                        .insertBefore(document.createElement('div'), document.querySelector('.dpad'));
            }
            get buttons() {
                return {
                    top: {"classes":["col-3"],"buttons":[{"key":0,"type":2,"label":".power"},{"key":-1,"type":0,"label":""},{"key":-1,"type":0,"label":""}]},
                    numbers: {"classes":["col-3"],"buttons":[{"key":26,"type":1,"label":"1"},{"key":27,"type":1,"label":"2"},{"key":28,"type":1,"label":"3"},{"key":29,"type":1,"label":"4"},{"key":30,"type":1,"label":"5"},{"key":31,"type":1,"label":"6"},{"key":32,"type":1,"label":"7"},{"key":33,"type":1,"label":"8"},{"key":34,"type":1,"label":"9"},{"key":-1,"type":0,"label":""},{"key":35,"type":1,"label":"0"},{"key":-1,"type":0,"label":""}]},
                    functional: {"classes":["col-3"],"buttons":[{"key":37,"type":1,"label":".back"},{"key":41,"type":2,"label":".home"},{"key":1,"type":2,"label":".menu"}]}
                }
            }
        }

        class Dpad extends ButtonsAbstract {
            render(config, part) {
                const container = document.querySelector(".dpad");
                const buttons = container.querySelectorAll('button, span')
                config.buttons.forEach((b, i) => {
                    if (buttons[i].tagName === "BUTTON") {
                        buttons[i].dataset.key = b.key;
                        buttons[i].dataset.type = b.type;
                        buttons[i].addEventListener("pointerdown", this.keyDownHandler);
                        buttons[i].addEventListener("pointerup", this.keyUpHandler);
                    }
                    let label = b.label[0] === "." ? this.getSvgIcon(b.label) : b.label;
                    buttons[i].innerHTML = label;
                });
            }

            get buttons() {
                return {
                    dpad: {
                        "buttons":[
                            {"key":27,"type":2,"label":".plus"},
                            {"key":-1,"type":0,"label":"Vol"},
                            {"key":28,"type":2,"label":".minus"},                            
                            
                            {"key":-1,"type":0,"label":""},
                            {"key":77,"type":1,"label":".up"},
                            {"key":-1,"type":0,"label":""},

                            {"key":75,"type":1,"label":".left"},
                            {"key":36,"type":1,"label":"OK"},
                            {"key":74,"type":1,"label":".right"},

                            {"key":-1,"type":0,"label":""},
                            {"key":76,"type":1,"label":".down"},
                            {"key":-1,"type":0,"label":""},                            
                            
                            {"key":70,"type":1,"label":".plus"},
                            {"key":-1,"type":0,"label":"CH"},
                            {"key":73,"type":1,"label":".minus"}
                        ]
                    }
                }
            }
        }

        class Lower extends ButtonsAbstract {
            get buttons() {
                return {
                    functionalLower: {"classes":["col-3"],"buttons":[{"key":26,"type":2,"label":".mute"},{"key":-1,"type":0,"label":""},{"key":7,"type":2,"label":".previous"}]},
                    media: {"classes":["col-4"],"buttons":[{"key":22,"type":2,"label":".skip-backward"},{"key":20,"type":2,"label":".rew"},{"key":19,"type":2,"label":".ffw"},{"key":21,"type":2,"label":".skip-forward"},{"key":18,"type":2,"label":".rec"},{"key":23,"type":2,"label":".stop"},{"key":25,"type":2,"label":".play-pause"}]},
                    colors: {"classes":["col-4"],"buttons":[{"key":3,"type":2,"label":".red"},{"key":4,"type":2,"label":".green"},{"key":6,"type":2,"label":".yellow"},{"key":5,"type":2,"label":".blue"}]}
                }
            }
        }

        class Keyboard extends ButtonsAbstract {
            get buttons() {
                return {
                    rowN: {"buttons":[{"key":26,"type":1,"label":"1"},{"key":27,"type":1,"label":"2"},{"key":28,"type":1,"label":"3"},{"key":29,"type":1,"label":"4"},{"key":30,"type":1,"label":"5"},{"key":31,"type":1,"label":"6"},{"key":32,"type":1,"label":"7"},{"key":33,"type":1,"label":"8"},{"key":34,"type":1,"label":"9"},{"key":35,"type":1,"label":"0"}]},
                    row1: {"buttons":[{"key":16,"type":1,"label":"Q"},{"key":22,"type":1,"label":"W"},{"key":4,"type":1,"label":"E"},{"key":17,"type":1,"label":"R"},{"key":19,"type":1,"label":"T"},{"key":25,"type":1,"label":"Z"},{"key":20,"type":1,"label":"U"},{"key":8,"type":1,"label":"I"},{"key":14,"type":1,"label":"O"},{"key":15,"type":1,"label":"P"}]},
                    row2: {"buttons":[{"key":0,"type":1,"label":"A"},{"key":18,"type":1,"label":"S"},{"key":3,"type":1,"label":"D"},{"key":5,"type":1,"label":"F"},{"key":6,"type":1,"label":"G"},{"key":7,"type":1,"label":"H"},{"key":9,"type":1,"label":"J"},{"key":10,"type":1,"label":"K"},{"key":11,"type":1,"label":"L"}]},
                    row3: {"buttons":[{"key":-1,"type":0,"label":""},{"key":24,"type":1,"label":"Y"},{"key":23,"type":1,"label":"X"},{"key":2,"type":1,"label":"C"},{"key":21,"type":1,"label":"V"},{"key":1,"type":1,"label":"B"},{"key":13,"type":1,"label":"N"},{"key":12,"type":1,"label":"M"},{"key":38,"type":1,"label":"&#x232b"}]},
                    row4: {"buttons":[{"key":-1,"type":0,"label":"&nbsp;"},{"key":40,"type":1,"label":"&nbsp"},{"key":36,"type":1,"label":"&#x23ce"}]}
                }
            }
        }

        class Menu extends PageHandler {
            constructor(pageController) {
                super(pageController);
                this.pageController = pageController;
                this.node = document.querySelector('nav.menu');
            } 
            toggle() {
                this.open = !this.open;
            }
            get open() {
                return this.node.dataset.open === "true";
            }
            set open(s) {
                this.node.dataset.open = typeof s === "boolean" && s ? "true" : "false";
            }
        }

        class Nav extends PageHandler {
            constructor(pageController) {
                super(pageController);
                this.node = document.querySelector('nav:not(.menu)');
                this.btns = document.querySelectorAll("nav a");
                this.btns.forEach((b) => {
                    b.addEventListener("click", this.handlePointerEvent.bind(this));
                })
            }

            handlePointerEvent(e) {
                e.preventDefault();
                e.currentTarget.pathname !== '/menu' && (this.pageController.menu.open = false);
                switch (e.currentTarget.pathname) {
                    case "/remote":
                    case "/keyboard":
                    case "/mouse":
                    case "/learn":
                    case "/ota":
                        this.pageController.page = e.currentTarget.pathname.replace(/^\//, "");
                        break;
                    case "/menu":
                        this.pageController.menu.toggle();
                        break;
                    case "/reboot":
                        this.pageController.ws.reboot();
                        break;
                }
            }
        }

        class Overlay extends PageHandler {
            constructor(pageController, node) {
                super(pageController);
                this.node = node;
                this.node.querySelector(".cancelIr")
                    .addEventListener("pointerup", () => {
                        this.pageController.ws.cancelIr(() => {this.show = false;});
                    });
            }
            set show(v) {
                this.node.classList.toggle("active", v);
            }

            set button(label) {
                const btn = this.node.querySelector("p button");
                if (btn) {
                    btn.innerHTML = label;
                }
            }
        }

        class Ota extends PageHandler {
            constructor(pageController) {
                super(PageController);
                this.initElements().initListeners().addListeners();
            }
            initElements() {
                this.node = document.querySelector('.ota form');
                this.inputFile = this.node.querySelector('input[type="file"]');
                this.trigger = this.node.querySelector('button[type="submit"]');
                this.progressBar = this.node.querySelector('progress');
                this.result = this.node.querySelector('p.result');
                this.reload = this.node.querySelector('p.reload');
                this.reloadCountdown = this.reload.querySelector('span');
                this.disabled = !this.hasFile;
                return this;
            }
            initListeners() {
                this.handleSubmit = this.submitHandler.bind(this);
                this.handleXhrReadyState = this.xhrReadyStateHandler.bind(this);
                this.handleXhrProgress = this.xhrProgressHandler.bind(this);
                return this;
            }
            addListeners() {
                this.inputFile.addEventListener('change', e => {
                    this.disabled = !this.hasFile;
                });
                this.node.addEventListener('submit', this.handleSubmit);
                return this;
            }
            submitHandler(e) {
                e.preventDefault();
                const file = this.inputFile.files[0];
                this.disabled = true;
                this.error = false;
                if (file.name.match(/.*\.bin/)) {
                    let data = new FormData();
                    data.append('file', file, file.name);
                    try {
                        this.initXhr();
                        this.xhr.send(data);
                        this.showProgress = true;
                    } catch (error) {
                        this.result.dataset.error = "true";
                        this.resultText = error.toString();
                        this.showProgress = false;
                    }
                } else {
                    this.inputFile.value = "";
                }
            }
            initXhr() {
                this.xhr = new XMLHttpRequest();
                this.xhr.open('POST', '/ota', true);
                this.xhr.addEventListener('readystatechange', this.handleXhrReadyState);
                this.xhr.upload.addEventListener('progress', this.handleXhrProgress);
            }
            xhrReadyStateHandler() {
                if (this.xhr.readyState === XMLHttpRequest.DONE) {
                    if (this.xhr.status === 200) {
                        this.resultText = this.xhr.responseText;
                        this.startReload();
                    } else {
                        this.error = this.xhr.statusText;
                    }
                    this.xhr.removeEventListener('readystatechange', this.handleXhrReadyState);
                    this.xhr.upload.removeEventListener('progress', this.handleXhrProgress);
                    delete this.xhr;
                    this.showProgress = false;
                }
            }
            xhrProgressHandler(e) {
                if (e.lengthComputable) {
                    const p = Math.floor(100 * e.loaded / e.total);
                    this.progress = p;
                }
            }
            startReload() {
                this.showReload = true;
                let countdown = 20;
                this.reloadCountdown.innerHTML = countdown.toString();
                const interval = setInterval(() => {
                    countdown -= 1;
                    this.reloadCountdown.innerHTML = countdown.toString();
                    if (countdown <= 0) {
                        clearInterval(interval);
                        location.reload();
                    }
                }, 1000);
            }
            set disabled(v) {
                this.trigger.disabled = "boolean" == typeof v && v;
            }
            get hasFile() {
                return !!this.inputFile.value;
            }
            set showProgress(v) {
                this.progressBar.dataset.show = ("boolean" == typeof v && v).toString();
            }
            set showReload(v) {
                this.reload.dataset.show = ("boolean" == typeof v && v).toString();
            }
            set progress(v) {
                this.progressBar.value = parseInt(v, 10);
                this.progressBar.innerHTML = `${v}%`;
            }
            set resultText(t) {
                this.result.innerHTML = t;
            }
            set error(e) {
                if (e instanceof Error) {
                    this.resultText = e.toString();
                }
                if ("string" === typeof e) {
                    this.resultText = e;
                }
                this.result.dataset.error = "boolean" === typeof e ? e.toString() : true;
            }
        }

        class PageController {
            run() {
                this.main = document.querySelector("main");
                this.nav = new Nav(this);
                this.menu = new Menu(this);
                this.ota = new Ota(this);
                this.upper = new Upper(this, document.querySelector("section.remote"));
                this.dpad = new Dpad(this, document.querySelector("section.remote"));
                this.lower = new Lower(this, document.querySelector("section.remote"));
                this.keyboard = new Keyboard(this, document.querySelector("section.keyboard"));
                this.mouse = new Mouse(this, document.querySelector("section.mouse"));
                this.learnOverlay = new Overlay(this, document.querySelector(".overlay.learn"));
                this.forgetOverlay = new Overlay(this, document.querySelector(".overlay.forget"));
                try {
                    this.ws = new WebsocketHandler(this).run();
                    return this.initBody()
                        .initForget()
                        .initClear()
                        .initVisibility();
                } catch (error) {
                    console.error(error);
                }
            }

            initVisibility() {
                document.addEventListener("visibilitychange", () => {
                    console.debug("Visibility: is hidden %s", document.hidden);
                    if (document.hidden) {
                        this.ws.close();
                    } else {
                        this.ws.connect();
                    }
                }, false);
                return this;
            }

            initBody() {
                document.body.addEventListener('pointerup', (e) => {
                    const p = e.composedPath();
                    if (p.indexOf(this.menu.node) < 0 && p.indexOf(this.nav.node) < 0) {
                        this.menu.open = false;
                    }
                });
                return this;
            }

            invokeLearn(btn) {
                this.learnOverlay.button = btn.innerHTML;
                this.ws.learn(btn, () => {this.learnOverlay.show = false;});
                this.learnOverlay.show = true;
            }

            initForget() {
                document.querySelector('button[name="forget"]')
                .addEventListener("pointerup", (e) => {
                    this.ws.forget(() => {this.forgetOverlay.show = false;});
                    this.forgetOverlay.show = true;
                });
                return this;
            }

            initClear() {
                document.querySelector('button[name="clear"]')
                .addEventListener("pointerup", (e) => {
                    if (confirm("Delete Configuration?")) {
                        this.ws.clear();
                    }
                });
                return this;
            }

            handleKeydown(e) {
                if (this.page === "learn" || !this.ws.active) return;
                this.ws.keydown(e.currentTarget)
            }

            handleKeyup (e) {
                if (this.page === "learn") {
                    this.invokeLearn(e.currentTarget)
                } else {
                    this.ws.keyup(e.currentTarget)
                }
            }

            get page() {
                return this.main.dataset.page;
            }
            set page(page) {
                this.main.dataset.page = page;
            }

            get active() {
                return !document.body.classList.contains("ws-off");
            }

            set active(v) {
                document.body.classList.toggle("ws-off", !v);
            }

            set sending(v) {
                if (v) {
                    document.body.classList.add("sending");
                } else {
                    this.nav.node.addEventListener('animationiteration', () => {
                        document.body.classList.remove("sending");
                    }, {once: true});
                }
            }
        }

        pageController = (new PageController()).run();

    </script>
</body>
</html>